## Домашнее задание  
Настраиваем центральный сервер для сбора логов  
Цель: В результате выполнения ДЗ студент настроит центральный сервер для сбора логов.  
в вагранте поднимаем 2 машины web и log  
на web поднимаем nginx  
на log настраиваем центральный лог сервер на любой системе на выбор  
- journald  
- rsyslog  
- elk  
настраиваем аудит следящий за изменением конфигов нжинкса  
  
все критичные логи с web должны собираться и локально и удаленно  
все логи с nginx должны уходить на удаленный сервер (локально только критичные)  
логи аудита должны также уходить на удаленную систему  
  
\* развернуть еще машину elk  
и таким образом настроить 2 центральных лог системы elk И какую либо еще  
в elk должны уходить только логи нжинкса  
во вторую систему все остальное  
  
## Решение  
Работа выполнена в виде Vagrantfile'а [см [здесь](https://github.com/dbudakov/16.log/blob/master/homework/Vagrantfile)], который реализует по одному скрипту для настройки каждой из машин.
### Настройка VM "web"
чистый скрипт лежит здесь [web.sh](https://github.com/dbudakov/16.log/blob/master/homework/web.sh)  
Для начала предустанавливаем nginx
```sh
yum install -y epel-release
yum install -y nginx
```
Записываем в некий файл список правил для настройка rsyslog,  
справку по диррективам можно посмотреть [[здесь]](https://github.com/dbudakov/16.log/blob/master/source.md) пункты `1.4` и `1.5`
```sh
cat > web_0 <<WEB
#LOCAL
#*.notice       /var/log/LOCAL/notice     #состояние, которое может потребовать внимания
#*.warn         /var/log/LOCAL/warn       #предупреждение
*.err           /var/log/LOCAL/err        #ошибка
*.crit          /var/log/LOCAL/crit       #критическое состояние
*.alert         /var/log/LOCAL/alert      #состояние, требующее немедленного вмешательства

#REMOTE
#*.*
auth.*          @@192.168.11.102:514      #Сообщения, поступающие от сервисов авторизации и безопасности
authpriv.*      @@192.168.11.102:514      #aналог "auth"
cron.*          @@192.168.11.102:514      #сообщения демона Cron
daemon.*        @@192.168.11.102:514      #сообщения от демонов
kern.*          @@192.168.11.102:514      #сообщения ядра Linux
#lpr.*                                    #сообщения, связанные с печатью
#mail.*                                   #сообщения подсистемы почты;
#mark.*                 
#news.*                                   #сообщения подсистемы новостей сети
#security.*                               #аналог "auth"
syslog.*        @@192.168.11.102:514      #системный журнал
user.*          @@192.168.11.102:514      #сообщения пользовательских программ
#uucp.*
local6.*        @@192.168.11.102:514      #зарезервировано для локального использования
local7.*        @@192.168.11.102:514      #зарезервировано для локального использования
WEB
```  
Вставляем содержимое созданого файла в `/etc/rsyslog.conf` и перезапускаем службу
```sh
sed -i ''$(awk '/@@remote-host:514/ {print NR}' /etc/rsyslog.conf)'r web_0'  /etc/rsyslog.conf
systemctl restart rsyslog
```  
Настраиваем централизованный сбор логов nginx  
```sh

sed -i 's!/var/log/nginx/access.log!syslog:server=192.168.11.102:514,facility=local6,tag=nginx_access,severity=info!' /etc/nginx/nginx.conf
```  
Для `error.log` используем уже знакомую комбинацию со вставкой из файла, а также добавляем веб сервис в автозагрузку и запускаем его:
```sh
cat > web_1 <<WEB
error_log syslog:server=192.168.11.102:514,facility=local6,tag=nginx_error;
WEB
sed -i ''$(awk '/error_log/ {print NR}' /etc/nginx/nginx.conf)'r web_1'  /etc/nginx/nginx.conf

systemctl enable nginx
systemctl start nginx
```  
